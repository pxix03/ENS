<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒí’ˆ ìƒì„¸ - ENS ì‡¼í•‘</title>

  <link rel="stylesheet" href="style.css">
  <script src="data.js"></script>
  <script src="search.js" defer></script>
</head>
<body>

<!-- ê³µí†µ í—¤ë” -->
<div class="header">
  <div class="top-row">
    <a href="index.html" class="logo">ENS</a>

    <div class="search-box">
      <input id="globalSearch" type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div class="header-user" id="userDisplay"></div>
  </div>

  <div class="categories">
    <button onclick="location.href='index.html'">í™ˆ</button>
    <button onclick="location.href='index.html#NBA'">NBA</button>
    <button onclick="location.href='index.html#FC'">FC</button>
    <button onclick="location.href='index.html#E-ìŠ¤í¬ì¸ '">E-ìŠ¤í¬ì¸ </button>
    <button onclick="location.href='shop.html'">ì‡¼í•‘</button>
    <button onclick="location.href='community.html'">ì»¤ë®¤ë‹ˆí‹°</button>
    <button onclick="location.href='game.html'">ê²½ê¸°</button>
  </div>
</div>

<!-- í†µí•© ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
<div id="searchResultBox" class="search-result-box"></div>

<!-- ====== ìƒí’ˆ ìƒì„¸ ====== -->
<div class="product-detail-container">
  <div class="product-detail-layout">

    <!-- ì™¼ìª½: ê°¤ëŸ¬ë¦¬(ì¸ë„¤ì¼ + ë©”ì¸ì´ë¯¸ì§€) -->
    <div class="product-gallery">
      <div class="product-thumbs" id="thumbList">
        <!-- JSì—ì„œ ì¸ë„¤ì¼ ë²„íŠ¼ ìƒì„± -->
      </div>

      <div class="product-main-image">
        <img id="detailImg" src="" alt="">
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì •ë³´ / ë²„íŠ¼ -->
    <div class="product-detail-info">
      <h1 id="detailName"></h1>
      <div id="detailPrice" class="product-detail-price"></div>
      <p id="detailDesc" class="product-detail-desc"></p>

      <div class="product-detail-actions">
        <button id="btnCart" class="btn-cart">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
        <button id="btnBuy" class="btn-buy">ë°”ë¡œêµ¬ë§¤</button>
      </div>
    </div>
  </div>

  <!-- ì•„ë˜: íƒ­(ì •ë³´ / êµ¬ë§¤í›„ê¸°) -->
  <div class="product-detail-tabs">
    <div class="product-tabs">
      <button class="product-tab-btn active" data-tab="info">ì •ë³´</button>
      <button class="product-tab-btn" data-tab="review">êµ¬ë§¤í›„ê¸°</button>
    </div>

    <div class="product-tab-panels">
      <div id="tab-info" class="product-tab-panel active">
        <!-- JSì—ì„œ ìƒí’ˆ ì •ë³´ ì±„ì›Œ ë„£ìŒ -->
      </div>

    <div id="tab-review" class="product-tab-panel">
        <section class="comment-section">
        <h3 class="comment-title">
        êµ¬ë§¤í›„ê¸°
        <span id="reviewCount" class="comment-count"></span>
        </h3>

        <!-- í›„ê¸° ë¦¬ìŠ¤íŠ¸ -->
        <div id="reviewList" class="comment-list"></div>

        <!-- í›„ê¸° ì‘ì„± -->
        <div class="comment-write">
        <textarea id="reviewInput" placeholder="êµ¬ë§¤ í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”"></textarea>
        <button onclick="saveReview()">ë“±ë¡</button>
        </div>
        </section>
        </div>
    </div>
  </div>
</div>

<script>
  // ===== ê³µí†µ: URL íŒŒë¼ë¯¸í„° =====
  function getQueryParam(key) {
    return new URLSearchParams(location.search).get(key);
  }

  const productName = getQueryParam("name");
  let currentProduct = null;

  // HTML ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€ìš©)
  function escapeHtml(str) {
    if (!str) return "";
    return str.replace(/[&<>"']/g, function (m) {
      return ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      })[m];
    });
  }

  // ===== êµ¬ë§¤í›„ê¸° ì €ì¥ìš© ê³µí†µ =====
  function getReviewStore() {
    try {
      const raw = localStorage.getItem("product_reviews") || "{}";
      const obj = JSON.parse(raw);
      return (obj && typeof obj === "object") ? obj : {};
    } catch (e) {
      return {};
    }
  }
  function saveReviewStore(store) {
    localStorage.setItem("product_reviews", JSON.stringify(store));
  }

  function renderReviews() {
    const listBox = document.getElementById("reviewList");
    const countEl = document.getElementById("reviewCount");
    if (!listBox || !productName) return;

    const store = getReviewStore();
    const list = Array.isArray(store[productName]) ? store[productName] : [];

    if (countEl) {
      countEl.textContent = list.length ? ` (${list.length})` : "";
    }

    if (!list.length) {
      listBox.innerHTML = `<div class="empty-comment">ì²« êµ¬ë§¤í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”.</div>`;
      return;
    }

    listBox.innerHTML = list.map(r => {
      const textHtml = escapeHtml(r.text || "").replace(/\n/g, "<br>");
      let dateTxt = "";
      if (r.createdAt) {
        const d = new Date(r.createdAt);
        dateTxt = d.toLocaleString();
      }
      return `
        <div class="comment-item">
          <div class="comment-meta">ìµëª… Â· ${dateTxt}</div>
          <div class="comment-text">${textHtml}</div>
        </div>
      `;
    }).join("");
  }

  function saveReview() {
    const input = document.getElementById("reviewInput");
    if (!input || !productName) return;

    const text = input.value.trim();
    if (!text) {
      alert("êµ¬ë§¤ í›„ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    const store = getReviewStore();
    if (!Array.isArray(store[productName])) {
      store[productName] = [];
    }

    store[productName].push({
      text,
      createdAt: Date.now()
    });

    saveReviewStore(store);
    input.value = "";
    renderReviews();
  }

  // ===== ì¥ë°”êµ¬ë‹ˆ ì €ì¥ìš© ê³µí†µ =====
  function getCart() {
    try {
      return JSON.parse(localStorage.getItem("ensCart") || "[]");
    } catch (e) {
      return [];
    }
  }
  function saveCart(cart) {
    localStorage.setItem("ensCart", JSON.stringify(cart));
  }
  function addToCart(product, qty) {
    const cart = getCart();
    const index = cart.findIndex(i => i.name === product.name);
    const q = qty || 1;

    if (index >= 0) {
      cart[index].qty = (cart[index].qty || 1) + q;
    } else {
      cart.push({
        name: product.name,
        price: product.price,
        img: product.img,
        qty: q
      });
    }
    saveCart(cart);
  }

  // ì¥ë°”êµ¬ë‹ˆ í† ìŠ¤íŠ¸ í‘œì‹œ
    function showCartToast() {
    let toast = document.getElementById("cartToast");
    if (!toast) {
        const actions = document.querySelector(".product-detail-actions");

        toast = document.createElement("div");
        toast.id = "cartToast";
        toast.innerHTML = `
        <div class="cart-toast-box">
            <div class="cart-toast-text">ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤.</div>
            <button class="cart-toast-btn" id="goCartBtn">ì¥ë°”êµ¬ë‹ˆ ë°”ë¡œê°€ê¸° &gt;</button>
        </div>
        `;

        // ğŸ‘‰ ë²„íŠ¼ ì˜ì—­(.product-detail-actions) ì•ˆì— ë„£ê¸°
        if (actions) {
        actions.appendChild(toast);
        } else {
        document.body.appendChild(toast); // í˜¹ì‹œ ëª» ì°¾ìœ¼ë©´ ì„ì‹œë¡œ body
        }

        const btn = document.getElementById("goCartBtn");
        if (btn) {
        btn.addEventListener("click", () => {
            toast.style.display = "none";
            location.href = "cart.html";
        });
        }
    }

    toast.style.display = "block";
    }


  // ===== ìƒí’ˆ ì •ë³´ ë Œë”ë§ =====
  function renderProduct() {
    const container = document.querySelector(".product-detail-container");

    if (!productName) {
      container.innerHTML = '<p class="empty-post">ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const item = shopData.find(p => p.name === productName);
    currentProduct = item;

    if (!item) {
      container.innerHTML = '<p class="empty-post">ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const imgEl   = document.getElementById("detailImg");
    const nameEl  = document.getElementById("detailName");
    const priceEl = document.getElementById("detailPrice");
    const descEl  = document.getElementById("detailDesc");
    const thumbList = document.getElementById("thumbList");
    const tabInfo = document.getElementById("tab-info");

    document.title = item.name + " - ENS ì‡¼í•‘";

    nameEl.textContent = item.name;
    priceEl.textContent = item.price;
    descEl.textContent = item.desc || "";

    tabInfo.innerHTML = `
      <h2 class="tab-info-title">ìƒí’ˆ ì •ë³´</h2>
      <p>${item.desc || "ìƒí’ˆ ì •ë³´ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤."}</p>
      <ul class="tab-info-list">
        <li>ë¸Œëœë“œ: ENS SPORTS (ë°ëª¨)</li>
        <li>ë°°ì†¡: í‰ê·  1~2ì¼ ì†Œìš”</li>
        <li>êµí™˜/ë°˜í’ˆ: ìˆ˜ë ¹ í›„ 7ì¼ ì´ë‚´ ê°€ëŠ¥</li>
      </ul>
    `;

    const images = (item.images && item.images.length)
      ? item.images
      : [item.img, item.img, item.img];

    imgEl.src = images[0];
    imgEl.alt = item.name;

    thumbList.innerHTML = images.map((src, idx) => `
      <button class="product-thumb ${idx === 0 ? "active" : ""}" data-src="${src}">
        <img src="${src}" alt="${item.name} ì¸ë„¤ì¼ ${idx + 1}">
      </button>
    `).join("");

    thumbList.addEventListener("click", (e) => {
      const btn = e.target.closest(".product-thumb");
      if (!btn) return;

      const src = btn.dataset.src;
      imgEl.src = src;

      document.querySelectorAll(".product-thumb").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });

    renderReviews();
  }

  // ì‹¤ì œ ë Œë”ë§ ì‹¤í–‰
  renderProduct();

  // ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ë²„íŠ¼
document.getElementById("btnCart").addEventListener("click", () => {
  // âœ… ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
  if (!getCurrentUser || !getCurrentUser()) {
    // ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ëª¨ë‹¬ ì—´ê¸°ë§Œ í•˜ê³  ì¢…ë£Œ
    if (typeof openLoginDialog === "function") {
      openLoginDialog();
    } else {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    }
    return;
  }

  if (!currentProduct) return;
  addToCart(currentProduct, 1);
  showCartToast();
});

// ë°”ë¡œêµ¬ë§¤ ë²„íŠ¼
document.getElementById("btnBuy").addEventListener("click", () => {
  // âœ… ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
  if (!getCurrentUser || !getCurrentUser()) {
    if (typeof openLoginDialog === "function") {
      openLoginDialog();
    } else {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    }
    return;
  }

  if (!currentProduct) return;
  addToCart(currentProduct, 1);
  location.href = "cart.html";
});



  // ===== íƒ­ ì „í™˜(ì •ë³´ / êµ¬ë§¤í›„ê¸°) =====
  document.querySelectorAll(".product-tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.tab; // "info" or "review"

      document.querySelectorAll(".product-tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      document.querySelectorAll(".product-tab-panel").forEach(panel => panel.classList.remove("active"));
      document.getElementById("tab-" + target).classList.add("active");
    });
  });
</script>


</body>
</html>

