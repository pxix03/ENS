<!DOCTYPE html> <!-- 한정헌 -->
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ENS 경기 기록</title>

  <!-- 전체 공통 스타일 시트 -->
  <link rel="stylesheet" href="style.css">

  <!-- 경기/쇼핑/커뮤니티 등의 데이터가 들어있는 JS (gameData 포함 가정) -->
  <script src="data.js"></script>

  <!-- 상단 공통 검색(검색창 + 결과 박스) 관련 스크립트 -->
  <script src="search.js" defer></script>

  <!-- 로그인/로그아웃 및 사용자 정보 표시용 스크립트 -->
  <script src="auth.js" defer></script>

  <!-- 장바구니 등 쇼핑 관련 공통 로직 -->
  <script src="cart.js" defer></script>

  <!-- 탭 상태를 URL 히스토리와 연동해주는 스크립트 -->
  <script src="tabs-history.js"></script>

</head>
<body>
<!-- ============================
     공통 헤더 + 검색 결과 박스
============================= -->
<div class="header">
  <div class="top-row">
    <!-- 로고: 메인(index.html)으로 이동 -->
    <a href="index.html" class="logo">ENS</a>

    <!-- 상단 전역 검색창 (search.js에서 이 input을 사용) -->
    <div class="search-box">
      <input id="globalSearch" type="text" placeholder="검색어를 입력하세요">
    </div>

    <!-- 로그인/유저 정보 표시 영역 -->
    <div class="header-user" id="userDisplay"></div>
  </div>

  <!-- 상단 카테고리 네비게이션 버튼들 -->
  <div class="categories">
    <button onclick="location.href='index.html'">홈</button>
    <button onclick="location.href='nba.html'">NBA</button>
    <button onclick="location.href='epl.html'">EPL</button>
    <button onclick="location.href='esports.html'">E-스포츠</button>
    <button onclick="location.href='shop.html'">쇼핑</button>
    <button onclick="location.href='community.html'">커뮤니티</button>
    <button onclick="location.href='game.html'">경기</button>
  </div>
</div>

<!-- 통합 검색 결과가 표시될 영역 (search.js에서 동적으로 사용) -->
<div id="searchResultBox" class="search-result-box"></div>

<!-- ==============================
     경기 상세 페이지 전체 레이아웃
     - 왼쪽: 스코어보드 + 기록/요약 탭
     - 오른쪽: 승부 예측 + 댓글
================================== -->
<main class="match-page">
  <!-- 상단 스코어보드 영역 -->
  <section class="match-header">
    <div class="match-header-top">
      <!-- 경기 일정 페이지로 돌아가는 버튼 -->
      <button class="match-back-btn" onclick="goBackFromMatch()">
        <span>◀</span>
        <span>경기 일정으로</span>
      </button>
    </div>

    <!-- 스코어보드 카드 -->
    <div class="match-scoreboard">
      <div class="match-score-top">
        <!-- 리그/종목 이름 (NBA/EPL 등) -->
        <div class="match-title" id="matchLeague"></div>
        <!-- 경기 상태 (경기전 / 진행중 / 종료 등) -->
        <div class="match-status" id="matchStatus">경기전</div>
      </div>

      <div class="match-score-main">
        <!-- 홈팀 정보 -->
        <div class="match-team match-team-home">
          <!-- 홈팀 이름 -->
          <div class="match-team-name" id="homeTeamName">홈팀</div>
          <!-- 서브 텍스트(추가 정보가 필요할 때 사용 가능, 현재는 사용 안 함) -->
          <div class="match-team-sub" id="homeTeamSub"></div>
        </div>

        <!-- 중앙 스코어 및 경기 정보 -->
        <div class="match-center">
          <div class="match-score-row">
            <!-- 홈팀 점수 -->
            <span class="match-score-big" id="homeScore">-</span>
            <span class="match-score-sep">:</span>
            <!-- 원정팀 점수 -->
            <span class="match-score-big" id="awayScore">-</span>
          </div>
          <!-- 날짜, 장소 등 메타 정보 -->
          <div class="match-meta">
            <span id="matchDate"></span>
            <span id="matchVenue"></span>
          </div>
        </div>

        <!-- 원정팀 정보 -->
        <div class="match-team match-team-away">
          <!-- 원정팀 이름 -->
          <div class="match-team-name" id="awayTeamName">원정팀</div>
          <!-- 서브 텍스트 -->
          <div class="match-team-sub" id="awayTeamSub"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 좌측 : 기록 탭 / 요약 탭(본문 영역) -->
  <section class="match-main">
    <!-- 탭 버튼 (기록 / 경기 요약) -->
    <div class="match-tabs">
      <!-- 기본 활성 탭: 기록 -->
      <button class="match-tab-btn active" data-tab="record">기록</button>
      <button class="match-tab-btn" data-tab="summary">경기 요약</button>
    </div>

    <!-- 기록 탭 컨텐츠 -->
    <div class="match-tab-content" id="tab-record">
      <h2 class="match-subtitle">팀 기록</h2>
      <!-- 팀별 기록 테이블 -->
      <table class="record-table">
        <thead>
          <tr>
            <th>팀</th>
            <th>득점</th>
            <th>리바운드</th>
            <th>어시스트</th>
            <th>스틸</th>
            <th>3점슛</th>
          </tr>
        </thead>
        <tbody id="teamRecordBody">
          <!-- JS에서 동적으로 행을 추가 -->
        </tbody>
      </table>
    </div>

    <!-- 경기 요약 탭 컨텐츠 (처음에는 hidden 클래스) -->
    <div class="match-tab-content hidden" id="tab-summary">
      <h2 class="match-subtitle">경기 요약</h2>
      <p id="matchSummaryText">
        경기 요약 내용이 여기에 표시됩니다. data.js의 desc 값을 기반으로 간단한 설명을 보여줍니다.
      </p>
    </div>
  </section>

  <!-- 우측 : 승부예측 + 응원 댓글 사이드바 -->
  <aside class="match-side">
    <!-- 승부 예측 카드 -->
    <div class="match-side-card">
      <h3>승부 예측</h3>
      <p class="side-caption">어느 팀이 더 강하다고 생각하나요?</p>

      <!-- 예측 퍼센트 바 영역 -->
      <div class="predict-bar">
        <!-- 홈팀 퍼센트 라벨 -->
        <div class="predict-row">
          <span id="predictHomeName">홈팀</span>
          <span id="predictHomePercent">0%</span>
        </div>
        <!-- 홈팀 퍼센트 바 -->
        <div class="predict-track">
          <div class="predict-fill" id="predictHomeFill" style="width:0%;"></div>
        </div>

        <!-- 원정팀 퍼센트 라벨 -->
        <div class="predict-row">
          <span id="predictAwayName">원정팀</span>
          <span id="predictAwayPercent">0%</span>
        </div>
        <!-- 원정팀 퍼센트 바 -->
        <div class="predict-track">
          <div class="predict-fill" id="predictAwayFill" style="width:0%;"></div>
        </div>
      </div>

      <!-- 투표 버튼 -->
      <div class="predict-actions">
        <button id="btnVoteHome">홈팀 승!</button>
        <button id="btnVoteAway">원정팀 승!</button>
      </div>

      <!-- 전체 투표 수 텍스트 -->
      <p class="side-caption small" id="predictTotalText">총 0표 투표됨</p>
    </div>

    <!-- 응원 댓글 카드 -->
    <div class="match-side-card">
      <h3>응원 댓글</h3>
      <p class="side-caption">경기 한 줄 평을 남겨보세요.</p>

      <!-- 댓글 입력 폼 -->
      <div class="comment-form">
        <textarea id="commentInput" rows="3" placeholder="메시지를 입력해주세요"></textarea>
        <button id="commentSubmit">등록</button>
      </div>

      <!-- 댓글 리스트 -->
      <ul class="comment-list" id="commentList">
        <!-- JS에서 댓글 렌더링 -->
      </ul>
    </div>
  </aside>
</main>

<script>
  // ===========================
  //  공통 네비게이션
  // ===========================
  // "경기 일정으로" 버튼 클릭 시 경기 목록 페이지로 이동
  function goBackFromMatch() {
    // 그냥 리스트 페이지로 보내기 (경기 일정으로)
    window.location.href = "game.html";
  }

  // ===========================
  //  URL 쿼리 파라미터 처리
  // ===========================
  // 예: game_detail.html?match=LA%20Lakers%20vs%20Boston
  function getQueryParam(key) {
    return new URLSearchParams(window.location.search).get(key);
  }

  // match 파라미터 값 (경기 이름)
  const matchParam = getQueryParam("match");
  const matchName = matchParam ? decodeURIComponent(matchParam) : null;
  let matchData = null;

  // URL에 match가 있으면 gameData에서 동일한 name을 가진 경기 찾기
  if (matchName) {
    matchData = gameData.find(g => g.name === matchName);
  }
  // 못 찾았거나 matchName이 없는데 gameData는 있는 경우: 첫 번째 경기로 대체
  if (!matchData && gameData.length) {
    matchData = gameData[0]; // 혹시 못 찾으면 첫 경기 사용
  }

  // 경기 이름을 "홈팀 vs 원정팀" 형태로 가정하고 분리
  const parts = (matchData.name || "").split("vs");
  const homeTeam = (parts[0] || "").trim();
  const awayTeam = (parts[1] || "").trim();

  // 이 경기만을 구분하기 위한 로컬스토리지 키 (투표/댓글 저장에 사용)
  const matchKey = "game_" + encodeURIComponent(matchData.name || "");

  /* ---------- 스코어보드 초기화 ---------- */
  function initHeader() {
    const leagueEl = document.getElementById("matchLeague");
    const dateEl   = document.getElementById("matchDate");
    const venueEl  = document.getElementById("matchVenue");

    // 리그/타입 (예: NBA, EPL 등)
    leagueEl.textContent = matchData.type || "경기";
    // 경기 날짜 (data.js의 date 필드)
    dateEl.textContent   = matchData.date || "날짜 미정";
    // 경기장(venue)이 있으면 앞에 구분점(·) 붙여서 표시
    venueEl.textContent  = matchData.venue ? " · " + matchData.venue : "";

    // 경기 상태 (예: 경기전, 종료 등)
    document.getElementById("matchStatus").textContent =
      matchData.status || "경기전";

    // 점수가 정의돼 있으면 값 사용, 없으면 '-' 표시
    document.getElementById("homeScore").textContent =
      (matchData.homeScore !== undefined) ? matchData.homeScore : "-";
    document.getElementById("awayScore").textContent =
      (matchData.awayScore !== undefined) ? matchData.awayScore : "-";

    // 팀 이름 (없으면 기본 텍스트)
    document.getElementById("homeTeamName").textContent = homeTeam || "홈팀";
    document.getElementById("awayTeamName").textContent = awayTeam || "원정팀";

    // 승부 예측 영역의 팀 이름도 동일하게 세팅
    document.getElementById("predictHomeName").textContent = homeTeam || "홈팀";
    document.getElementById("predictAwayName").textContent = awayTeam || "원정팀";

    // 경기 요약 텍스트 (data.js의 desc 사용, 없으면 기본 문구)
    document.getElementById("matchSummaryText").textContent =
      matchData.desc || "경기 요약 정보가 없습니다.";
  }

  /* ---------- 탭(기록 / 요약) ---------- */
  // 현재 선택된 탭 상태: record / summary
  let currentMatchTab = "record";

  // 탭 변경 + 히스토리 반영
  function changeMatchTab(tab, push = true) {
    currentMatchTab = tab;

    // 탭 버튼에 active 클래스 토글
    const buttons = document.querySelectorAll(".match-tab-btn");
    buttons.forEach(btn => {
      const t = btn.dataset.tab;
      btn.classList.toggle("active", t === tab);
    });

    // 탭 내용 박스(기록/요약) 숨김/표시 전환
    const recordBox = document.getElementById("tab-record");
    const summaryBox = document.getElementById("tab-summary");
    if (recordBox && summaryBox) {
      recordBox.classList.toggle("hidden", tab !== "record");
      summaryBox.classList.toggle("hidden", tab !== "summary");
    }

    // URL / 히스토리 (?mdtab=summary 등) 업데이트
    if (window.updateTabHistory && push) {
      updateTabHistory("mdtab", tab, true);
    }
  }

  /* ---------- 탭(기록 / 요약) 초기 이벤트 바인딩 ---------- */
  function initTabs() {
    const buttons = document.querySelectorAll(".match-tab-btn");
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab || "record";
        // 버튼 클릭 시 탭 변경 + 히스토리 반영
        changeMatchTab(tab, true);
      });
    });
  }

  /* ---------- 팀 기록 테이블 ---------- */
  function initTeamRecord() {
    const body = document.getElementById("teamRecordBody");
    body.innerHTML = "";

    // data.js 안에 homeRecord / awayRecord가 있으면 가져오고,
    // 없으면 기본 0값을 가진 객체로 초기화
    const recordHome = matchData.homeRecord || {
      points: 0, rebounds: 0, assists: 0, steals: 0, threes: 0
    };
    const recordAway = matchData.awayRecord || {
      points: 0, rebounds: 0, assists: 0, steals: 0, threes: 0
    };

    // 테이블에 표시할 두 팀 정보 배열
    const rows = [
      { team: homeTeam || "홈팀", rec: recordHome },
      { team: awayTeam || "원정팀", rec: recordAway }
    ];

    // 각 팀에 대해 <tr> 요소 생성 후 tbody에 추가
    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.team}</td>
        <td>${r.rec.points}</td>
        <td>${r.rec.rebounds}</td>
        <td>${r.rec.assists}</td>
        <td>${r.rec.steals}</td>
        <td>${r.rec.threes}</td>
      `;
      body.appendChild(tr);
    });
  }

  /* ---------- 승부 예측 (로컬스토리지로 저장) ---------- */
  // 이 경기의 예측 데이터를 구분하기 위한 key
  const predictKey = matchKey + "_predict";

  // { home: 홈팀 득표 수, away: 원정팀 득표 수 }
  let predictData = { home: 0, away: 0 };

  // 로컬스토리지에서 예측 데이터 불러오기
  function loadPrediction() {
    try {
      const stored = localStorage.getItem(predictKey);
      if (stored) predictData = JSON.parse(stored);
    } catch (e) {}
    updatePredictionUI();
  }

  // 예측 데이터 저장
  function savePrediction() {
    try {
      localStorage.setItem(predictKey, JSON.stringify(predictData));
    } catch (e) {}
  }

  // 투표 버튼 클릭 시 호출되는 함수
  // side: "home" 또는 "away"
  function vote(side) {
    if (side === "home") predictData.home++;
    if (side === "away") predictData.away++;
    savePrediction();
    updatePredictionUI();
  }

  // 승부 예측 UI 갱신
  function updatePredictionUI() {
    const total = predictData.home + predictData.away;
    // 전체 표 수가 0이 아니면 퍼센트 계산, 아니면 0%
    const homePercent = total ? Math.round(predictData.home / total * 100) : 0;
    const awayPercent = total ? 100 - homePercent : 0;

    // 상단 숫자 퍼센트 표시
    document.getElementById("predictHomePercent").textContent = homePercent + "%";
    document.getElementById("predictAwayPercent").textContent = awayPercent + "%";
    // 게이지 바 width 조정
    document.getElementById("predictHomeFill").style.width = homePercent + "%";
    document.getElementById("predictAwayFill").style.width = awayPercent + "%";
    // 총 투표 수 텍스트
    document.getElementById("predictTotalText").textContent =
      "총 " + total + "표 투표됨";
  }

  /* ---------- 댓글 (응원 메시지) ---------- */
  // 이 경기 댓글을 위한 로컬스토리지 key
  const commentKey = matchKey + "_comments";

  // 댓글 데이터 배열 (최신 댓글이 앞에 오도록 관리)
  let comments = [];

  // 로컬스토리지에서 댓글 읽어오기
  function loadComments() {
    try {
      const stored = localStorage.getItem(commentKey);
      if (stored) comments = JSON.parse(stored);
    } catch (e) {}
    renderComments();
  }

  // 댓글 데이터 저장
  function saveComments() {
    try {
      localStorage.setItem(commentKey, JSON.stringify(comments));
    } catch (e) {}
  }

  // 새 댓글 추가
  function addComment(text) {
    const trimmed = text.trim();
    if (!trimmed) return;  // 공백만 있으면 무시

    // 현재 시각을 "MM-DD HH:MM" 형태로 표시
    const now = new Date();
    const timeText = now.toLocaleString("ko-KR", {
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });

    // 새로운 댓글을 배열 앞쪽에 추가 (최신순)
    comments.unshift({
      text: trimmed,
      time: timeText
    });
    saveComments();
    renderComments();
  }

  // 댓글 리스트 렌더링
  function renderComments() {
    const listEl = document.getElementById("commentList");
    listEl.innerHTML = "";

    // 댓글이 하나도 없을 때 안내 문구
    if (!comments.length) {
      const li = document.createElement("li");
      li.className = "comment-empty";
      li.textContent = "첫 댓글을 남겨보세요.";
      listEl.appendChild(li);
      return;
    }

    // 각 댓글 객체를 실제 li 요소로 만들어 리스트에 추가
    comments.forEach(c => {
      const li = document.createElement("li");
      li.className = "comment-item";
      li.innerHTML = `
        <div class="comment-text">${c.text}</div>
        <div class="comment-meta">${c.time}</div>
      `;
      listEl.appendChild(li);
    });
  }

  // 댓글 입력/등록 버튼 초기화
  function initCommentForm() {
    const input = document.getElementById("commentInput");
    const btn   = document.getElementById("commentSubmit");

    btn.addEventListener("click", () => {
      addComment(input.value); // 입력값으로 댓글 추가
      input.value = "";        // 입력창 비우기
      input.focus();           // 포커스 다시 입력창으로
    });
  }

  /* ---------- 초기화 루틴 ---------- */
  // 페이지 로딩 시 필요한 모든 초기화 함수 호출
  initHeader();        // 스코어보드/요약에 기본 데이터 세팅
  initTabs();          // 탭 클릭 이벤트 연결
  initTeamRecord();    // 팀 기록 테이블 초기화
  loadPrediction();    // 승부 예측 데이터 로드 + UI 반영
  loadComments();      // 댓글 데이터 로드 + 렌더링
  initCommentForm();   // 댓글 폼 동작 연결

  // 탭 히스토리 (기록 / 요약) - tabs-history.js 사용 시
  if (window.setupTabHistory) {
    // URL 파라미터 mdtab 값을 기반으로 탭 상태 복원 / 히스토리 연동
    setupTabHistory("mdtab", "record", (tab, push) => {
      changeMatchTab(tab, push);
    });
  } else {
    // tabs-history 를 못 쓰면 기본은 '기록' 탭만 활성
    changeMatchTab("record", false);
  }

  // 승부 예측 버튼 이벤트 연결
  document.getElementById("btnVoteHome").addEventListener("click", () => vote("home"));
  document.getElementById("btnVoteAway").addEventListener("click", () => vote("away"));

</script>

</body>
</html>
